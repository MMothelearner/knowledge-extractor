<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æäº¤é“¾æ¥ - Knowledge Extractor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”— æäº¤é“¾æ¥</h1>
            <p><a href="index.html">â† è¿”å›é¦–é¡µ</a></p>
        </header>

        <div class="section">
            <h2>æäº¤é“¾æ¥</h2>
            <div id="message" class="message"></div>

            <form id="linkForm">
                <div class="form-group">
                    <label for="url">é“¾æ¥åœ°å€ *</label>
                    <input type="url" id="url" name="url" placeholder="https://example.com" required>
                </div>

                <div class="form-group">
                    <label for="title">é“¾æ¥æ ‡é¢˜</label>
                    <input type="text" id="title" name="title" placeholder="è¾“å…¥é“¾æ¥æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰">
                </div>

                <div class="form-group">
                    <label for="description">é“¾æ¥æè¿°</label>
                    <textarea id="description" name="description" placeholder="è¾“å…¥é“¾æ¥æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn">æäº¤é“¾æ¥</button>
                    <a href="index.html" class="btn btn-secondary">å–æ¶ˆ</a>
                </div>
            </form>
        </div>

        <div class="section">
            <h2>æœ€è¿‘æäº¤çš„é“¾æ¥</h2>
            <div id="linksList" style="margin-top: 20px;">
                <p style="color: #999;">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // å¤„ç†è¡¨å•æäº¤
        document.getElementById('linkForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const linkData = {
                url: document.getElementById('url').value,
                title: document.getElementById('title').value || document.getElementById('url').value,
                description: document.getElementById('description').value
            };

            try {
                const response = await fetch(`${API_BASE}/links/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(linkData)
                });

                const data = await response.json();
                const messageDiv = document.getElementById('message');

                if (data.success) {
                    messageDiv.className = 'message success';
                    messageDiv.textContent = 'âœ“ é“¾æ¥æäº¤æˆåŠŸï¼Œæ­£åœ¨å¤„ç†...';
                    document.getElementById('linkForm').reset();
                    setTimeout(() => loadLinks(), 1000);
                } else {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'âœ— æäº¤å¤±è´¥ï¼š' + data.error;
                }
            } catch (error) {
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message error';
                messageDiv.textContent = 'âœ— é”™è¯¯ï¼š' + error.message;
            }
        });

        // åŠ è½½é“¾æ¥åˆ—è¡¨
        async function loadLinks() {
            try {
                const response = await fetch(`${API_BASE}/links`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    const linksList = document.getElementById('linksList');
                    linksList.innerHTML = '';

                    // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
                    const sorted = data.data.sort((a, b) => 
                        new Date(b.createdAt) - new Date(a.createdAt)
                    );

                    for (const link of sorted.slice(0, 10)) {
                        const statusColor = {
                            'processing': '#ff9800',
                            'completed': '#4caf50',
                            'failed': '#f44336'
                        }[link.status] || '#999';

                        const knowledgeInfo = link.extractedKnowledge ? 
                            `<p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                æå–ï¼š${link.extractedKnowledge.total || 0} ä¸ª | 
                                æ–°å¢ï¼š${link.extractedKnowledge.new || 0} ä¸ª | 
                                ç›¸åŒï¼š${link.extractedKnowledge.identical || 0} ä¸ª
                            </p>` : '';

                        const linkHTML = `
                            <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 5px 0; color: #333;">${link.title}</h3>
                                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                            <a href="${link.url}" target="_blank" style="color: #667eea; text-decoration: none;">
                                                ${link.url}
                                            </a>
                                        </p>
                                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                            æäº¤æ—¶é—´ï¼š${new Date(link.createdAt).toLocaleString()}
                                        </p>
                                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                            çŠ¶æ€ï¼š<span style="color: ${statusColor}; font-weight: bold;">${link.status}</span>
                                        </p>
                                        ${knowledgeInfo}
                                    </div>
                                    <button onclick="deleteLink('${link.id}')" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9em; margin-left: 10px;">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                        linksList.innerHTML += linkHTML;
                    }
                } else {
                    document.getElementById('linksList').innerHTML = 
                        '<p style="color: #999;">è¿˜æ²¡æœ‰æäº¤ä»»ä½•é“¾æ¥</p>';
                }
            } catch (error) {
                console.error('Error loading links:', error);
            }
        }

        // åˆ é™¤é“¾æ¥
        async function deleteLink(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé“¾æ¥å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/links/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    loadLinks();
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–é“¾æ¥åˆ—è¡¨
        loadLinks();
        // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡
        setInterval(loadLinks, 10000);
    </script>
</body>
</html>
