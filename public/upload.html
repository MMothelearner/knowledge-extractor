<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šä¼ æ–‡æ¡£ - Knowledge Extractor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“¤ ä¸Šä¼ æ–‡æ¡£</h1>
            <p><a href="index.html">â† è¿”å›é¦–é¡µ</a></p>
        </header>

        <div class="section">
            <h2>ä¸Šä¼ æ–‡æ¡£</h2>
            <div id="message" class="message"></div>

            <form id="uploadForm">
                <div class="form-group">
                    <label for="title">æ–‡æ¡£æ ‡é¢˜</label>
                    <input type="text" id="title" name="title" placeholder="è¾“å…¥æ–‡æ¡£æ ‡é¢˜" required>
                </div>

                <div class="form-group">
                    <label for="description">æ–‡æ¡£æè¿°</label>
                    <textarea id="description" name="description" placeholder="è¾“å…¥æ–‡æ¡£æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>

                <div class="form-group">
                    <label for="file">é€‰æ‹©æ–‡ä»¶</label>
                    <input type="file" id="file" name="file" 
                           accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.gif" required>
                    <small>æ”¯æŒæ ¼å¼ï¼šPDFã€Wordã€TXTã€å›¾ç‰‡ï¼ˆPNGã€JPGã€GIFï¼‰</small>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn">ä¸Šä¼ æ–‡æ¡£</button>
                    <a href="index.html" class="btn btn-secondary">å–æ¶ˆ</a>
                </div>
            </form>
        </div>

        <div class="section">
            <h2>æœ€è¿‘ä¸Šä¼ çš„æ–‡æ¡£</h2>
            <div id="documentsList" style="margin-top: 20px;">
                <p style="color: #999;">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // å¤„ç†è¡¨å•æäº¤
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('file', document.getElementById('file').files[0]);
            formData.append('title', document.getElementById('title').value);
            formData.append('description', document.getElementById('description').value);

            try {
                const response = await fetch(`${API_BASE}/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                const messageDiv = document.getElementById('message');

                if (data.success) {
                    messageDiv.className = 'message success';
                    messageDiv.textContent = 'âœ“ æ–‡æ¡£ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨å¤„ç†...';
                    document.getElementById('uploadForm').reset();
                    setTimeout(() => loadDocuments(), 1000);
                } else {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'âœ— ä¸Šä¼ å¤±è´¥ï¼š' + data.error;
                }
            } catch (error) {
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message error';
                messageDiv.textContent = 'âœ— é”™è¯¯ï¼š' + error.message;
            }
        });

        // åŠ è½½æ–‡æ¡£åˆ—è¡¨
        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE}/documents`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    const documentsList = document.getElementById('documentsList');
                    documentsList.innerHTML = '';

                    // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
                    const sorted = data.data.sort((a, b) => 
                        new Date(b.createdAt) - new Date(a.createdAt)
                    );

                    for (const doc of sorted.slice(0, 10)) {
                        const statusColor = {
                            'processing': '#ff9800',
                            'completed': '#4caf50',
                            'failed': '#f44336'
                        }[doc.status] || '#999';

                        const knowledgeInfo = doc.extractedKnowledge ? 
                            `<p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                æå–ï¼š${doc.extractedKnowledge.total || 0} ä¸ª | 
                                æ–°å¢ï¼š${doc.extractedKnowledge.new || 0} ä¸ª | 
                                ç›¸åŒï¼š${doc.extractedKnowledge.identical || 0} ä¸ª
                            </p>` : '';

                        const docHTML = `
                            <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h3 style="margin: 0 0 5px 0; color: #333;">${doc.title}</h3>
                                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                            ${doc.fileName} (${(doc.fileSize / 1024).toFixed(2)} KB)
                                        </p>
                                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                            ä¸Šä¼ æ—¶é—´ï¼š${new Date(doc.createdAt).toLocaleString()}
                                        </p>
                                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                            çŠ¶æ€ï¼š<span style="color: ${statusColor}; font-weight: bold;">${doc.status}</span>
                                        </p>
                                        ${knowledgeInfo}
                                    </div>
                                    <button onclick="deleteDocument('${doc.id}')" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9em;">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                        documentsList.innerHTML += docHTML;
                    }
                } else {
                    document.getElementById('documentsList').innerHTML = 
                        '<p style="color: #999;">è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡æ¡£</p>';
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        // åˆ é™¤æ–‡æ¡£
        async function deleteDocument(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/documents/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    loadDocuments();
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ–‡æ¡£åˆ—è¡¨
        loadDocuments();
        // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡
        setInterval(loadDocuments, 10000);
    </script>
</body>
</html>
