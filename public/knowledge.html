<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“ - Knowledge Extractor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ’¡ çŸ¥è¯†åº“</h1>
            <p><a href="index.html">â† è¿”å›é¦–é¡µ</a></p>
        </header>

        <div class="section">
            <h2>çŸ¥è¯†åº“ç®¡ç†</h2>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="æœç´¢çŸ¥è¯†ç‚¹..." 
                       style="flex: 1; min-width: 200px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                <button onclick="searchKnowledge()" class="btn">æœç´¢</button>
                <button onclick="loadKnowledge()" class="btn btn-secondary">é‡ç½®</button>
                <div style="flex: 1; min-width: 200px;">
                    <select id="exportFormat" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="">é€‰æ‹©å¯¼å‡ºæ ¼å¼</option>
                        <option value="markdown">å¯¼å‡ºä¸º Markdown</option>
                        <option value="json">å¯¼å‡ºä¸º JSON</option>
                        <option value="csv">å¯¼å‡ºä¸º CSV</option>
                        <option value="html">å¯¼å‡ºä¸º HTML</option>
                    </select>
                </div>
                <button onclick="exportKnowledge()" class="btn">å¯¼å‡º</button>
            </div>

            <div id="message" class="message"></div>

            <div id="knowledgeList" style="margin-top: 20px;">
                <p style="color: #999;">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentKnowledge = [];

        // åŠ è½½çŸ¥è¯†ç‚¹
        async function loadKnowledge() {
            try {
                const response = await fetch(`${API_BASE}/knowledge-points`);
                const data = await response.json();

                if (data.success) {
                    currentKnowledge = data.data;
                    displayKnowledge(currentKnowledge);
                }
            } catch (error) {
                console.error('Error loading knowledge:', error);
            }
        }

        // æœç´¢çŸ¥è¯†ç‚¹
        async function searchKnowledge() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                loadKnowledge();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/knowledge-points/search/${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.success) {
                    displayKnowledge(data.data);
                }
            } catch (error) {
                console.error('Error searching knowledge:', error);
            }
        }

        // æ˜¾ç¤ºçŸ¥è¯†ç‚¹
        function displayKnowledge(knowledge) {
            const knowledgeList = document.getElementById('knowledgeList');

            if (!knowledge || knowledge.length === 0) {
                knowledgeList.innerHTML = '<p style="color: #999;">æ²¡æœ‰æ‰¾åˆ°çŸ¥è¯†ç‚¹</p>';
                return;
            }

            knowledgeList.innerHTML = '';

            for (const point of knowledge) {
                const statusColor = {
                    'draft': '#ff9800',
                    'reviewed': '#4caf50',
                    'published': '#2196f3'
                }[point.status] || '#999';

                const sourcesHTML = point.sources && point.sources.length > 0 ?
                    `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                        <strong>æ¥æºï¼š</strong>
                        ${point.sources.map(s => 
                            s.url ? `<a href="${s.url}" target="_blank" style="color: #667eea; text-decoration: none;">${s.title}</a>` 
                                  : s.title
                        ).join(', ')}
                    </div>` : '';

                const tagsHTML = point.tags && point.tags.length > 0 ?
                    `<div style="margin-top: 10px;">
                        ${point.tags.map(tag => 
                            `<span style="display: inline-block; background: #e0e0e0; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 0.9em;">${tag}</span>`
                        ).join('')}
                    </div>` : '';

                const methodsHTML = point.methods && point.methods.length > 0 ?
                    `<div style="margin-top: 10px;">
                        <strong>è§£å†³æ–¹æ³•ï¼š</strong>
                        <ol style="margin: 5px 0 0 20px;">
                            ${point.methods.map(method => `<li>${method}</li>`).join('')}
                        </ol>
                    </div>` : '';

                const pointHTML = `
                    <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 10px 0; color: #333;">${point.problem}</h3>
                                <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                    çŠ¶æ€ï¼š<span style="color: ${statusColor}; font-weight: bold;">${point.status}</span>
                                </p>
                                <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                    åˆ›å»ºæ—¶é—´ï¼š${new Date(point.createdAt).toLocaleString()}
                                </p>
                                ${methodsHTML}
                                ${tagsHTML}
                                ${sourcesHTML}
                            </div>
                            <div style="margin-left: 10px;">
                                <button onclick="editKnowledge('${point.id}')" class="btn" style="padding: 8px 16px; font-size: 0.9em; display: block; margin-bottom: 5px;">
                                    ç¼–è¾‘
                                </button>
                                <button onclick="deleteKnowledge('${point.id}')" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9em;">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                knowledgeList.innerHTML += pointHTML;
            }
        }

        // ç¼–è¾‘çŸ¥è¯†ç‚¹
        function editKnowledge(id) {
            alert('ç¼–è¾‘åŠŸèƒ½å°†åœ¨ä¸‹ä¸€ç‰ˆæœ¬å®ç°');
        }

        // åˆ é™¤çŸ¥è¯†ç‚¹
        async function deleteKnowledge(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŸ¥è¯†ç‚¹å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/knowledge-points/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    const messageDiv = document.getElementById('message');
                    messageDiv.className = 'message success';
                    messageDiv.textContent = 'âœ“ çŸ¥è¯†ç‚¹å·²åˆ é™¤';
                    loadKnowledge();
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // å¯¼å‡ºçŸ¥è¯†ç‚¹
        async function exportKnowledge() {
            const format = document.getElementById('exportFormat').value;
            if (!format) {
                alert('è¯·é€‰æ‹©å¯¼å‡ºæ ¼å¼');
                return;
            }

            try {
                window.location.href = `${API_BASE}/knowledge-points/export/${format}`;
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–çŸ¥è¯†ç‚¹
        loadKnowledge();
        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
        setInterval(loadKnowledge, 30000);

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchKnowledge();
            }
        });
    </script>
</body>
</html>
